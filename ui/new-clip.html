
<section class="new-clip">
	<style>
		#record-voice + label + div, #upload-file + label + div {
			margin-left: 1em;
			padding: 1em;
			padding-bottom: 0px;
		}
		#script-select {	
			max-width: calc(100% - 6ch);
		}
		#title-input {
			max-width: calc(100% - 16ch);
		}
		.new-clip .hbox {
			display: flex;
			align-items: center;
		}
		.new-clip .hbox select, .hbox input[type=text] {
			width: 100%;
			flex-shrink: 1;
		}
		.new-clip .hbox label {
			margin-left: 1em;
			margin-right: .5em;
		}
		.new-clip .hbox label:first-child {
			margin-left: 0px;
		}
		.new-clip h2 {
			margin-top: 0px;
		}
		/* Show upload/recording elements only when that option is selected. */
		#record-voice          + label + div { display: none; }
		#record-voice:checked  + label + div { display: block; }
		#upload-file           + label + div { display: none;}
		#upload-file:checked   + label + div { display: block;}
	</style>

	<h2>Add a Clip</h2>

	<div class="hbox">
		<label for="title-input">Title</label>
		<input type="text" id="title-input" value="Untitled"/>

		<label for="color-select">Color</label>
		<input type="color" id="color-select" value="#000000"/>
	</div>

	<br>

	<!-- Script selection -->
	<div class="hbox">
		<label for="script-select">Script </label>
		<select class="script" id="script-select" onchange="updateScript()">
		</select>
	</div>
	<textarea rows="6" id="transcript"></textarea>
	<script>
		for (let key in speechScripts) {
			let script = speechScripts[key].replace(/\s\s*/g, ' ');
			$('#script-select').appendChild(option(key, {value: script}));
		}

		function updateScript() {
			document.querySelector('#transcript').innerHTML 
				= document.querySelector('select.script').value;
		}
		updateScript();
	</script>


	<!-- Upload Options -->
	<input type="radio" name="add-recording" id="upload-file" checked>
	<label for="upload-file">Upload a file</label>
	<div>
		<input type='file' id='audio-file-input' name='recording'/>
	</div>
	<br>
	<input type="radio" name="add-recording" id="record-voice">
	<label for="record-voice">Record your voice</label>
	<div>
		<button id="start-recording">Start Recording</button>
		<button id="stop-recording">Stop Recording</button>
	</div>
	<br>
	<br>
	<!-- Submit -->
	<button id="submit" onclick="submitAudio()">Add Clip</button>
	<script>

		function submitAudio() {

			let clip = new Clip();
			let formData = new FormData();

			let transcriptText = $('#transcript').value;
			formData.append('transcript', transcriptText);
			clip.transcript = transcriptText;
			clip.title = $('#title-input').value;
			clip.color = $('#color-select').value;

			if ($('#upload-file').checked) {
				fileInput = $('#audio-file-input')
				if (fileInput.files.length < 1) return

				let recording = fileInput.files[0];
				formData.append('recording', recording);
				clip.loadAudioFile(recording);

			} else if ($('#record-voice').checked) {
				//TODO: Handle recording
			} else {
				alert('Please upload a file or make a recording.');
				return;
			}

			$('button.new-clip').classList.add('hidden');
			$('button.new-clip + .spinner').classList.remove('hidden');
			
			hideModal();
			
			fetch('./backend.cgi', { method: 'POST', body: formData})
			.then(response => {
				if (!response.ok) throw new Error(response.status);
				if (response.headers.get('Content-Length') < 2) return {};
				return response.json();
			}).then(data => {
				$('button.new-clip').classList.remove('hidden');
				$('button.new-clip + .spinner').classList.add('hidden');

				if (!data.hasOwnProperty('phones') || data.phones.length < 1) {
					alert("We couldn't identify the words in your clip." 
					    + "Make sure that the transcript matches the audio.");
					return;
				}
				
				clip.loadResponse(data);
				globalState.mutate('clips', clips => clips.push(clip));
				globalState.set('playingClip', clip);
				globalState.set('previewClip', clip);

			})
			// .catch(() => alert('The server returned an error code'));
		}
	</script>
</section>
